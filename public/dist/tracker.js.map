{"version":3,"file":"tracker.js","mappings":";;;;;;;;;;;;;;;AAAa;;AAE0C;;AAEvD,iEAAe;AACf;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,uBAAuB,oEAAqB;;AAE5C;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;AC5Ba;;AAEb;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,8CAA8C,UAAU,mBAAmB,YAAY,WAAW;AAClG,iCAAiC;AACjC;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,uCAAuC;AACvC;AACA;AACA,SAAS,IAAI;AACb;;AAEA;AACA,0BAA0B,OAAO;AACjC;;AAEA,uDAAuD,OAAO;;;;;;;;UC7C9D;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;WCtBA;WACA;WACA;WACA;WACA,yCAAyC,wCAAwC;WACjF;WACA;WACA;;;;;WCPA;;;;;WCAA;WACA;WACA;WACA,uDAAuD,iBAAiB;WACxE;WACA,gDAAgD,aAAa;WAC7D;;;;;;;;;;;;;ACNa;;AAEuC;AAOzB;;AAE3B;AACA;;AAEA;AACA;AACA,eAAe,UAAU;AACzB;AACA;AACA;AACA,GAAG;;AAEH;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA,+CAA+C,KAAK,WAAW;AAC/D;AACA,0DAA0D;AAC1D;AACA,uBAAuB,sEAAoB;AAC3C,0BAA0B,uEAAqB;AAC/C;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA,KAAK;AACL;AACA;AACA,IAAI;AACJ;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA,aAAa,gEAAc;AAC3B,aAAa,4DAAc;AAC3B,IAAI;AACJ;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA,mDAAmD,0BAA0B;AAC7E;;AAEA;AACA;AACA;AACA;AACA;AACA,QAAQ;AACR,QAAQ;AACR;;AAEA;AACA;AACA;AACA;AACA,IAAI;AACJ;AACA;AACA,GAAG;;AAEH;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA,gDAAgD,cAAc;AAC9D;;AAEA;AACA;AACA;;AAEA;AACA,uBAAuB,6BAA6B;AACpD;AACA,yDAAyD,UAAU;;AAEnE;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,GAAG;;AAEH;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA,2DAA2D,kEAAa;;AAExE;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,IAAI;AACJ;;AAEA;AACA,+BAA+B,gCAAgC;AAC/D;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;;AAEA;AACA,qBAAqB,sEAAoB;AACzC,wBAAwB,uEAAqB;AAC7C;;AAEA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA,GAAG;AACH;AACA;AACA,GAAG;AACH;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA,qBAAqB,sDAAI;AACzB,wBAAwB,sDAAI;;AAE5B;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA,CAAC,U","sources":["webpack://kibanalytics/./src/client/class-listener.client.js","webpack://kibanalytics/./src/client/utils.client.js","webpack://kibanalytics/webpack/bootstrap","webpack://kibanalytics/webpack/runtime/define property getters","webpack://kibanalytics/webpack/runtime/hasOwnProperty shorthand","webpack://kibanalytics/webpack/runtime/make namespace object","webpack://kibanalytics/./src/client/tracker.client.js"],"sourcesContent":["'use strict';\n\nimport { getPrefixedAttributes } from './utils.client';\n\nexport default (element, className, prefix, type, value, trackEventFn) => () => {\n    const classData = {\n        name: className,\n        prefix,\n        type,\n        value\n    };\n\n    const elementData = {\n        tagName: element.tagName\n    };\n\n    const customData = getPrefixedAttributes('data-kbs-', element);\n\n    const data = {\n        class: classData,\n        element: elementData,\n        ...customData\n    };\n\n    const options = {\n        sendBeacon: data.element.tagName === 'A'\n    };\n    return trackEventFn(type, data, options);\n}","'use strict';\n\nconst hook = (_this, method, callback) => {\n    const orig = _this[method];\n\n    return (...args) => {\n        callback.apply(null, args);\n\n        return orig.apply(_this, args);\n    };\n};\n\nconst adblockEnabled = () => {\n    let ade;\n    const boe = document.getElementsByTagName('body')[0];\n\n    if (boe) {\n        ade = document.createElement('div');\n        ade.setAttribute('class', 'ads ad adsbox doubleclick ad-placement carbon-ads');\n        ade.setAttribute('style', 'height:1px;width:1px;position: absolute;left:-999px;top:-999px;');\n        ade.textContent = '&nbsp;';\n        boe.appendChild(ade);\n    }\n\n    return !!ade && ade.offsetHeight === 0;\n}\n\nconst cookiesEnabled = (navigator && navigator.cookieEnabled) || !!document.cookie;\n\nconst getPrefixedAttributes = (attrPrefix, element) => {\n    return element\n        .getAttributeNames()\n        .reduce((acc, name) => {\n            if (name.startsWith(attrPrefix)) {\n                const attrName = name.replace(attrPrefix, '');\n                if (attrName) return { ...acc, [attrName]: element.getAttribute(name) }\n            }\n            return acc;\n        }, {});\n}\n\nconst getClassPrefixRegExp = (prefix) => {\n    return new RegExp(`^${prefix}-([a-z]+)-([\\\\w]+[\\\\w-]*)$`);\n}\n\nconst getEventClassSelector = (prefix) => `[class*=\\'${prefix}-\\']`;\n\nexport {\n    hook,\n    adblockEnabled,\n    cookiesEnabled,\n    getPrefixedAttributes,\n    getClassPrefixRegExp,\n    getEventClassSelector\n};","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","'use strict';\n\nimport classListener from './class-listener.client';\nimport {\n\tadblockEnabled,\n\tcookiesEnabled,\n\thook,\n\tgetClassPrefixRegExp,\n\tgetEventClassSelector\n} from './utils.client.js';\n\n(window => {\n\tconst scriptStartedTs = (new Date()).getTime();\n\n\tconst {\n\t\tscreen,\n\t\tnavigator: { language },\n\t\tlocation,\n\t\tdocument,\n\t\thistory,\n\t} = window;\n\n\t/*\n\t\tDoes not work with modules <script type=\"module\">\n\t\tif we change this script to a module on the future\n\t */\n\tconst script = document.currentScript;\n\n\tconst attr = script.getAttribute.bind(script);\n\tconst listeners = new Map();\n    const host = script?.src ? (new URL(script.src)).origin : location.origin;\n\n\tlet serverUrl = attr('data-server-url') || `${host}/collect`; // default value\n\tlet autoTrack = attr('data-auto-track') !== 'false';\n\tlet eventClassPrefix = attr('data-css-prefix') || 'kbs'; // default value\n\tlet serverSideData = {};\n\tlet eventClassRegex = getClassPrefixRegExp(eventClassPrefix);\n\tlet eventClassSelector = getEventClassSelector(eventClassPrefix);\n\tlet callback = null;\n\tlet currentUrl = location.href;\n\tlet currentRef = document.referrer;\n\tlet lastEvent = null;\n\n\t/* Collect metrics */\n\n\tconst collect = async (type, payload, sendBeacon = false) => {\n\t\t/*\n\t\t\teventTs will be used only to calculate scriptEventStartedDelta,\n\t\t\tas it's going to be overrided by the server.\n\t\t*/\n\t\tconst eventTs = (new Date()).getTime();\n\n\t\tconst url = serverUrl;\n\t\tconst body = {\n\t\t\turl: {\n\t\t\t\thref: currentUrl\n\t\t\t},\n\t\t\treferrer: currentRef,\n\t\t\tevent: {\n\t\t\t\tts: {\n\t\t\t\t\tstarted: eventTs,\n\t\t\t\t\tscriptEventStartedDelta: eventTs - scriptStartedTs\n\t\t\t\t},\n\t\t\t\ttype,\n\t\t\t\tpayload\n\t\t\t},\n\t\t\tdevice: {\n\t\t\t\tscreen: {\n\t\t\t\t\twidth: screen.width,\n\t\t\t\t\theight: screen.height\n\t\t\t\t}\n\t\t\t},\n\t\t\tbrowser: {\n\t\t\t\tlanguage,\n\t\t\t\tadblock: adblockEnabled(),\n\t\t\t\tcookies: cookiesEnabled\n\t\t\t},\n\t\t\tserverSide: serverSideData\n\t\t};\n\n\t\tif (sendBeacon) {\n\t\t\t/*\n\t\t\t\tA problem with sending analytics is that a site often wants to send analytics when the user\n\t\t\t\thas finished with a page: for example, when the user navigates to another page. In this situation\n\t\t\t\tthe browser may be about to unload the page, and in that case the browser may choose not to send\n\t\t\t\tasynchronous XMLHttpRequest requests.\n\t\t\t */\n\n\t\t\tconst blob = new Blob([JSON.stringify(body)], { type: 'application/json' });\n\t\t\tconst queued = navigator.sendBeacon(url, blob);\n\n\t\t\t/*\n\t\t\t\tThe sendBeacon() method returns true if the user agent successfully queued the data for transfer.\n\t\t\t\tOtherwise, it returns false.\n\t\t\t */\n\t\t\treturn (queued)\n\t\t\t\t? { status: 'success', event_id: 'sendBeacon' }\n\t\t\t\t: { status: 'error', message: 'User agent failed to queue the data transfer' };\n\t\t}\n\n\t\tconst response = await fetch(url, {\n\t\t\tmethod: 'post',\n\t\t\theaders: {\n\t\t\t\t'content-type': 'application/json'\n\t\t\t},\n\t\t\tbody: JSON.stringify(body),\n\t\t\tcredentials: 'include'\n\t\t});\n\n\t\tconst json = response.ok ? await response.json() : null;\n\n\t\tlastEvent = {\n\t\t\tdata: body,\n\t\t\tresponse: {\n\t\t\t\tstatusCode: response.status,\n\t\t\t\tdata: json\n\t\t\t}\n\t\t};\n\n\t\treturn lastEvent;\n\t};\n\n\t/*\n\t\tHandle events\n\t */\n\n\tconst track = async (type = 'custom', data = {}, options = {}) => {\n\t\tconst response = await collect(type, data, options.sendBeacon);\n\n\t\tif (callback) callback(response);\n\t\treturn response;\n\t};\n\n\t// @TODO keeps the reference, allow a public method to remove the event listner\n\tconst trackEvent = ({ selector, type, data, label }) => {\n\t\tconst element = document.querySelector(selector);\n\t\tif (!element) throw new Error(`Element witg selector ${selector} not found.`);\n\n\t\telement.addEventListener(type, () => track(label ?? type, data), true);\n\t};\n\n\tconst trackEventList = (list) => {\n\t\tfor (const event of list) {\n\t\t\ttrackEvent(event);\n\t\t}\n\t};\n\n\tconst trackEventListUrl = async (url) => {\n\t\tconst list = await fetch(url, {\n\t\t\tmethod: 'get',\n\t\t\theaders: {\n\t\t\t\t'content-type': 'application/json'\n\t\t\t}\n\t\t}).then(response => response.json());\n\n\t\ttrackEventList(list);\n\t};\n\n\t/*\n\t\tHandle class events\n\t */\n\n\tconst addClassEvents = node => {\n\t\tconst elements = node.querySelectorAll(eventClassSelector);\n\t\tArray.prototype.forEach.call(elements, addClassEvent);\n\t};\n\n\tconst removeClassEvents = node => {\n\t\tconst elements = node.querySelectorAll(eventClassSelector);\n\t\tArray.prototype.forEach.call(elements, removeClassEvent);\n\t};\n\n\tconst addClassEvent = element => {\n\t\tconst classes = element.getAttribute('class')?.split(' ');\n\t\tif (!classes) return;\n\n\t\tfor (const className of classes) {\n\t\t\tif (!eventClassRegex.test(className)) continue;\n\n\t\t\tconst [prefix, type, value] = className.split('-');\n\t\t\tif (!listeners.has(className)) listeners.set(className, classListener(element, className, prefix, type, value, track));\n\n\t\t\telement.addEventListener(type, listeners.get(className), true);\n\t\t}\n\t};\n\n\tconst removeClassEvent = element => {\n\t\tconst classes = element.getAttribute('class')?.split(' ');\n\t\tif (!classes) return;\n\n\t\tfor (const className of classes) {\n\t\t\tconst type = className.split('-')[1];\n\n\t\t\telement.removeEventListener(type, listeners.get(className), true);\n\t\t\tlisteners.delete(className);\n\t\t}\n\t};\n\n\t/*\n\t\tHandle history changes\n\t */\n\tconst handlePush = (state, title, url) => {\n\t\tif (!url) return;\n\n\t\tcurrentRef = currentUrl;\n\t\tcurrentUrl = location.href;\n\n\t\tif (currentUrl !== currentRef) {\n\t\t\ttrack('pageview');\n\t\t}\n\t};\n\n\tconst observeDocument = () => {\n\t\tconst monitorMutate = mutations => {\n\t\t\tmutations.forEach(mutation => {\n\t\t\t\tconst element = mutation.target;\n\t\t\t\taddClassEvent(element);\n\t\t\t\taddClassEvents(element);\n\t\t\t});\n\t\t};\n\n\t\tconst observer = new MutationObserver(monitorMutate);\n\t\tobserver.observe(document, { childList: true, subtree: true });\n\t};\n\n\t// @TODO function to set all configurations at once\n\t// @TODO maybe transform this object to a JavaScript class\n\t// @TODO delay inicialization by html property, allowing initialization by JavaScript\n\n\tconst kbs = {\n\t\tget serverUrl() {\n\t\t\treturn serverUrl;\n\t\t},\n\t\tset serverUrl(url) {\n\t\t\tserverUrl = url;\n\t\t\treturn serverUrl;\n\t\t},\n\t\tget serverSideData() {\n\t\t\treturn serverSideData\n\t\t},\n\t\tset serverSideData(obj) {\n\t\t\tserverSideData = (typeof obj === 'object') ? obj : {};\n\t\t},\n\t\tget eventClassPrefix() {\n\t\t\treturn eventClassPrefix;\n\t\t},\n\t\tset eventClassPrefix(prefix) {\n\t\t\tremoveClassEvents(document);\n\n\t\t\teventClassPrefix = prefix;\n\t\t\teventClassRegex = getClassPrefixRegExp(prefix);\n\t\t\teventClassSelector = getEventClassSelector(prefix);\n\t\t\taddClassEvents(document);\n\n\t\t\treturn eventClassPrefix;\n\t\t},\n\t\tget callback() {\n\t\t\treturn callback;\n\t\t},\n\t\tset callback(fn) {\n\t\t\tcallback = (typeof fn === 'function') ? fn : null;\n\t\t\treturn callback;\n\t\t},\n\t\tget lastEvent() {\n\t\t\treturn lastEvent;\n\t\t},\n\t\ttrack,\n\t\ttrackEvent,\n\t\ttrackEventList,\n\t\ttrackEventListUrl\n\t};\n\tObject.freeze(kbs);\n\n\tif (!window.kbs) {\n\t\twindow.kbs = kbs;\n\t}\n\n\t/* Start */\n\n\thistory.pushState = hook(history, 'pushState', handlePush);\n\thistory.replaceState = hook(history, 'replaceState', handlePush);\n\n\tconst update = () => {\n\t\tif (document.readyState === 'complete') {\n\t\t\tif (autoTrack) track('pageview');\n\t\t\taddClassEvents(document);\n\t\t\tobserveDocument();\n\t\t}\n\t};\n\n\tdocument.addEventListener('readystatechange', update, true);\n\n\tupdate();\n})(window);"],"names":[],"sourceRoot":""}